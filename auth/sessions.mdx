---
title: Sessions & Tokens
description: JWT tokens, session management, and authentication state
---

# Sessions & Tokens

InsForge uses JWT tokens for stateless authentication with automatic session management.

## Token Types

### Access Token
- **Format**: JWT (JSON Web Token)
- **Expiry**: 7 days
- **Usage**: API authentication
- **Storage**: localStorage or memory

### Refresh Token
- **Format**: JWT
- **Expiry**: 30 days
- **Usage**: Get new access token
- **Storage**: localStorage or httpOnly cookie

### Session Cookie
- **Format**: Session ID
- **Expiry**: Browser session
- **Usage**: Alternative to JWT
- **Storage**: Cookie

## JWT Token Structure

```javascript
// Decoded JWT payload
{
  "sub": "user-uuid",        // User ID
  "email": "user@example.com",
  "role": "user",            // or "admin"
  "iat": 1704067200,         // Issued at
  "exp": 1704672000          // Expires at (7 days)
}
```

## Token Management

### Store Tokens

```javascript
// After login
function storeAuth(response) {
  localStorage.setItem('access_token', response.access_token);
  localStorage.setItem('refresh_token', response.refresh_token);
  localStorage.setItem('user_id', response.user.id);
  
  // Optional: Store expiry for client-side checks
  const payload = JSON.parse(atob(response.access_token.split('.')[1]));
  localStorage.setItem('token_expires', payload.exp * 1000);
}
```

### Check Token Expiry

```javascript
function isTokenExpired() {
  const expires = localStorage.getItem('token_expires');
  if (!expires) return true;
  
  return Date.now() > parseInt(expires);
}

function getValidToken() {
  if (isTokenExpired()) {
    return refreshToken();
  }
  
  return localStorage.getItem('access_token');
}
```

### Refresh Token

```javascript
async function refreshToken() {
  const refresh = localStorage.getItem('refresh_token');
  
  if (!refresh) {
    // No refresh token, redirect to login
    window.location.href = '/login';
    return null;
  }
  
  try {
    const response = await fetch('http://localhost:7130/api/auth/v2/refresh', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ refresh_token: refresh })
    });
    
    if (!response.ok) {
      throw new Error('Refresh failed');
    }
    
    const data = await response.json();
    localStorage.setItem('access_token', data.access_token);
    
    // Update expiry
    const payload = JSON.parse(atob(data.access_token.split('.')[1]));
    localStorage.setItem('token_expires', payload.exp * 1000);
    
    return data.access_token;
  } catch (error) {
    // Refresh failed, clear tokens and redirect
    localStorage.clear();
    window.location.href = '/login';
    return null;
  }
}
```

## Auto-Refresh Interceptor

```javascript
// Axios interceptor
import axios from 'axios';

const api = axios.create({
  baseURL: 'http://localhost:7130'
});

// Request interceptor
api.interceptors.request.use(async (config) => {
  const token = await getValidToken();
  if (token) {
    config.headers.Authorization = `Bearer ${token}`;
  }
  return config;
});

// Response interceptor for 401s
api.interceptors.response.use(
  (response) => response,
  async (error) => {
    if (error.response?.status === 401) {
      const newToken = await refreshToken();
      if (newToken) {
        // Retry original request
        error.config.headers.Authorization = `Bearer ${newToken}`;
        return api.request(error.config);
      }
    }
    return Promise.reject(error);
  }
);
```

## Session Management

### Get Active Sessions

```bash
curl http://localhost:7130/api/auth/v2/sessions \
  -H "Authorization: Bearer TOKEN"
```

Response:
```json
{
  "sessions": [
    {
      "id": "session-id",
      "userId": "user-id",
      "userAgent": "Mozilla/5.0...",
      "ipAddress": "192.168.1.1",
      "createdAt": "2024-01-01T00:00:00Z",
      "lastActiveAt": "2024-01-01T12:00:00Z"
    }
  ]
}
```

### Revoke Session

```bash
curl -X DELETE http://localhost:7130/api/auth/v2/sessions/SESSION_ID \
  -H "Authorization: Bearer TOKEN"
```

### Logout All Sessions

```bash
curl -X POST http://localhost:7130/api/auth/v2/sign-out-all \
  -H "Authorization: Bearer TOKEN"
```

## React Session Hook

```jsx
import { createContext, useContext, useEffect, useState } from 'react';

const SessionContext = createContext();

export function SessionProvider({ children }) {
  const [session, setSession] = useState(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    checkSession();
    
    // Check token expiry every minute
    const interval = setInterval(checkSession, 60000);
    return () => clearInterval(interval);
  }, []);

  async function checkSession() {
    const token = localStorage.getItem('access_token');
    const expires = localStorage.getItem('token_expires');
    
    if (!token || !expires) {
      setSession(null);
      setLoading(false);
      return;
    }
    
    // Check if expired
    if (Date.now() > parseInt(expires)) {
      // Try refresh
      const newToken = await refreshToken();
      if (!newToken) {
        setSession(null);
        setLoading(false);
        return;
      }
    }
    
    // Get user info
    try {
      const response = await fetch('http://localhost:7130/api/auth/v2/me', {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      
      if (response.ok) {
        const data = await response.json();
        setSession(data.user);
      } else {
        setSession(null);
      }
    } catch (error) {
      setSession(null);
    } finally {
      setLoading(false);
    }
  }

  async function logout() {
    const token = localStorage.getItem('access_token');
    
    if (token) {
      await fetch('http://localhost:7130/api/auth/v2/sign-out', {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${token}` }
      });
    }
    
    localStorage.clear();
    setSession(null);
  }

  return (
    <SessionContext.Provider value={{ session, loading, logout, refresh: checkSession }}>
      {children}
    </SessionContext.Provider>
  );
}

export function useSession() {
  return useContext(SessionContext);
}

// Usage
function App() {
  const { session, loading, logout } = useSession();
  
  if (loading) return <div>Loading...</div>;
  if (!session) return <LoginPage />;
  
  return (
    <div>
      <p>Welcome {session.name}</p>
      <button onClick={logout}>Logout</button>
    </div>
  );
}
```

## Security Best Practices

### Token Storage

```javascript
// Development - localStorage is OK
localStorage.setItem('access_token', token);

// Production - use secure methods
class SecureTokenStorage {
  // Store in memory
  private accessToken: string | null = null;
  
  // Store refresh in httpOnly cookie
  setTokens(access: string, refresh: string) {
    this.accessToken = access;
    
    // Send refresh token to backend to set as httpOnly cookie
    fetch('/api/auth/set-cookie', {
      method: 'POST',
      credentials: 'include',
      body: JSON.stringify({ refresh })
    });
  }
  
  getAccessToken() {
    return this.accessToken;
  }
  
  async refreshToken() {
    // Refresh using httpOnly cookie
    const response = await fetch('/api/auth/refresh', {
      method: 'POST',
      credentials: 'include'
    });
    
    const data = await response.json();
    this.accessToken = data.access_token;
    return this.accessToken;
  }
}
```

### Session Security

1. **Use HTTPS** - Prevent token interception
2. **Short expiry** - Minimize exposure window
3. **Rotate tokens** - New token on each refresh
4. **Validate on backend** - Never trust client
5. **Monitor sessions** - Detect suspicious activity

## Troubleshooting

| Issue | Solution |
|-------|----------|
| "Invalid token" | Token expired or malformed, refresh or re-login |
| "Token expired" | Use refresh token to get new access token |
| "No session" | User not logged in, redirect to login |
| "Multiple sessions" | Normal - user logged in from multiple devices |

## Next Steps

<CardGroup cols={2}>
  <Card title="API Keys" href="/auth/api-keys">
    Alternative authentication method
  </Card>
  <Card title="Security" href="/auth/overview">
    Security best practices
  </Card>
</CardGroup>